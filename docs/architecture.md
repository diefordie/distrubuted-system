# System Architecture Documentation

## Gambaran Umum

Sistem ini merupakan Distributed Synchronization System â€” sistem terdistribusi yang tahan gangguan (fault-tolerant) dan menyediakan sinkronisasi data antar node menggunakan beberapa komponen utama: 
    - Raft Consensus Algorithm untuk koordinasi dan replikasi log,
    - Distributed Lock Manager untuk manajemen kunci bersama,
    - Distributed Cache dengan protokol koherensi MESI, dan
    - Distributed Queue berbasis Consistent Hashing.

Fokus sistem ini adalah menjaga konsistensi dan koherensi data antar node dalam satu klaster tanpa bergantung pada load balancer atau sistem eksternal lain.

## Arsitektur Diagram
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLUSTER NODES                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚   Node 1     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Node 2     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ (Follower)   â”‚  Raft +  â”‚  (Leader)    â”‚  Raft + â”‚    â”‚
â”‚   â”‚   :8001      â”‚  Cache   â”‚   :8002      â”‚  Queue  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  Sync    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚          â”‚                         â”‚                 â”‚    â”‚
â”‚          â”‚                         â”‚                 â”‚    â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚    â”‚
â”‚                  Raft Heartbeat                      â”‚    â”‚
â”‚                                                      â”‚    â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚    â”‚
â”‚                  â”‚   Node 3     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                  â”‚ (Follower)   â”‚                         â”‚
â”‚                  â”‚   :8003      â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

Komunikasi antarnode dilakukan melalui HTTP RPC (REST API) menggunakan AioHTTP, dengan serialisasi data berbasis JSON.
## Arsitektur Komponen

### 1. **Raft Consensus Layer**

**Flow Diagram:**
```
Client Command
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     AppendEntries RPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Leader    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Follower   â”‚
â”‚   Node 2    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Node 1    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Success/Failure        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Majority Ack?
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Commit &   â”‚
â”‚   Apply     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2. **Distributed Lock Manager**

**Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Lock Manager Architecture               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Lock Table   â”‚        â”‚ Wait-for     â”‚           â”‚
â”‚  â”‚               â”‚        â”‚   Graph      â”‚           â”‚
â”‚  â”‚ resource1 â†’   â”‚        â”‚              â”‚           â”‚
â”‚  â”‚  {owners,     â”‚        â”‚ client1 â†’ R2 â”‚           â”‚
â”‚  â”‚   mode,       â”‚        â”‚ client2 â†’ R1 â”‚           â”‚
â”‚  â”‚   acquired_at}â”‚        â”‚   (Deadlock!)â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚          â”‚                       â”‚                   â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                  â”‚                                   â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚          â”‚  Deadlock     â”‚                           â”‚
â”‚          â”‚  Detector     â”‚                           â”‚
â”‚          â”‚  (DFS Cycle)  â”‚                           â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                  â”‚                                   â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚          â”‚ Redis Persist â”‚                           â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

### 3. **Distributed Cache with MESI Protocol**

**MESI State Machine:**
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Invalid   â”‚â—„â”€â”€â”€â”€â”
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
                           â”‚            â”‚
                    Local Read          â”‚
                    (Miss, Load)        â”‚
                           â”‚            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
              â”Œâ”€â”€â”€â”€â–ºâ”‚  Exclusive  â”‚     â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â”‚            â”‚            â”‚
        No other      Local Write       â”‚
         caches            â”‚            â”‚
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
              â”‚     â”‚  Modified   â”‚     â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â”‚            â”‚            â”‚
              â”‚      Write-back     Remote
              â”‚            â”‚         Write
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
              â””â”€â”€â”€â”€â”€â”¤   Shared    â”œâ”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



### 4. **Distributed Queue with Consistent Hashing**

**Consistent Hash Ring:**
```
             Hash Space: 0 to 2^32-1
                 
                    Node1-vn0
                      â”‚
        Node3-vn2 â”€â”€â”€â”€â”¼â”€â”€â”€â”€ Node2-vn1
                 \    â”‚    /
                  \   â”‚   /
                   \  â”‚  /
                    \ â”‚ /
                     \â”‚/
               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
               â”‚   Messages   â”‚
               â”‚  hash(msg)   â”‚
               â”‚  â†’ clockwise â”‚
               â”‚  â†’ node      â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Pola Komunikasi


**Normal (Leader Ada):**
```
Client Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node 1  â”‚â”€â”€â”€â”€â”€â”€â–º Forward to Leader â”€â”€â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚(Followerâ”‚                                  â”‚ Node 2  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚(Leader) â”‚
                                             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                  â”‚
                                             Execute
                                             Command
                                                  â”‚
                                             â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                                             â”‚ Responseâ”‚
                                             â”‚ to Client
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ketika Leader Bermasalah:**
```
1. Leader fails (Node 2)
         â”‚
         â–¼
2. Heartbeat timeout (3-5s)
         â”‚
         â–¼
3. New election triggered
         â”‚
         â–¼
4. Node 1 becomes candidate
         â”‚
         â–¼
5. Request votes from Node 3
         â”‚
         â–¼
6. Majority achieved â†’ Node 1 is Leader
         â”‚
         â–¼
7. Resume normal operations
```




## ğŸš€ Deployment Architecture

### Production Deployment (Recommended):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Load Balancer (HAProxy/Nginx)       â”‚
â”‚                    443 (HTTPS)                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚                     â”‚                    â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ Node 1  â”‚          â”‚  Node 2  â”‚        â”‚  Node 3  â”‚
â”‚ (AZ-1)  â”‚          â”‚  (AZ-2)  â”‚        â”‚  (AZ-3)  â”‚
â”‚ 8001    â”‚          â”‚  8002    â”‚        â”‚  8003    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                     â”‚                    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ Redis Clusterâ”‚
                    â”‚ (Replicated) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


## ğŸ”§ Configuration Parameters

### Environment Variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `NODE_ID` | node1 | Unique node identifier |
| `NODE_PORT` | 8001 | HTTP API port |
| `CLUSTER_ADDRS` | localhost:8001,... | Comma-separated cluster addresses |
| `REDIS_HOST` | localhost | Redis server host |
| `REDIS_PORT` | 6379 | Redis server port |
| `RAFT_ELECTION_TIMEOUT_MIN` | 3.0 | Min election timeout (seconds) |
| `RAFT_ELECTION_TIMEOUT_MAX` | 5.0 | Max election timeout (seconds) |
| `RAFT_HEARTBEAT_INTERVAL` | 1.0 | Heartbeat interval (seconds) |
| `CACHE_MAX_SIZE` | 1000 | Maximum cache entries |
| `LOCK_DEFAULT_TTL` | 300 | Default lock TTL (seconds) |

